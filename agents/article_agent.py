"""
æ–‡ç« æ’°å†™Agent
è´Ÿè´£ç”Ÿæˆå•ç¯‡å®Œæ•´çš„å­¦ä¹ æ–‡ç« ï¼Œæ ¹æ®ä¸»é¢˜ç±»å‹çµæ´»è°ƒæ•´å†…å®¹é£æ ¼
"""
import re
import requests
from .base_agent import BaseAgent
from config import AGENT_ROLES, ARTICLE_CONFIG, AI_CONFIG


class ArticleAgent(BaseAgent):
    """æ–‡ç« æ’°å†™ä¸“å®¶Agent"""
    
    def __init__(self):
        role = AGENT_ROLES["article_writer"]
        super().__init__(role["name"], role["system_prompt"])
    
    def _detect_topic_type(self, topic: str, description: str = "") -> str:
        """
        æ£€æµ‹ä¸»é¢˜ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å†…å®¹é£æ ¼
        """
        combined = f"{topic} {description}".lower()
        
        # æŠ€æœ¯/ç¼–ç¨‹ç±»
        tech_keywords = ['python', 'java', 'javascript', 'react', 'vue', 'node', 'api', 
                        'ç¼–ç¨‹', 'å¼€å‘', 'ä»£ç ', 'ç®—æ³•', 'æ•°æ®åº“', 'sql', 'linux', 'docker',
                        'æ¡†æ¶', 'å‰ç«¯', 'åç«¯', 'æœåŠ¡å™¨', 'äº‘è®¡ç®—', 'ai', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ']
        
        # äººç‰©/æ˜æ˜Ÿ/åäººç±»
        person_keywords = ['æ˜æ˜Ÿ', 'æ¼”å‘˜', 'æ­Œæ‰‹', 'è‰ºäºº', 'åäºº', 'äººç‰©', 'ä¼ è®°', 'ç”Ÿå¹³',
                          'ä»‹ç»', 'ç®€ä»‹', 'ä¸ªäºº', 'å¶åƒ', 'çƒæ˜Ÿ', 'è¿åŠ¨å‘˜', 'ä½œå®¶', 'å¯¼æ¼”',
                          'ä¼ä¸šå®¶', 'ç§‘å­¦å®¶', 'æ”¿æ²»å®¶', 'å†å²äººç‰©']
        
        # ç§‘æ™®/çŸ¥è¯†ç±»
        science_keywords = ['ç§‘å­¦', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'å¤©æ–‡', 'åœ°ç†', 'å†å²', 'æ–‡åŒ–',
                           'åŸç†', 'ç°è±¡', 'ä¸ºä»€ä¹ˆ', 'å¦‚ä½•', 'ä»€ä¹ˆæ˜¯', 'ç§‘æ™®']
        
        # ç”Ÿæ´»/å¨±ä¹ç±»
        life_keywords = ['ç¾é£Ÿ', 'æ—…æ¸¸', 'å¥åº·', 'å…»ç”Ÿ', 'è¿åŠ¨', 'ç”µå½±', 'éŸ³ä¹', 'æ¸¸æˆ',
                        'æ—¶å°š', 'ç©¿æ­', 'ç¾å¦†', 'å® ç‰©', 'å®¶å±…', 'è‚²å„¿']
        
        # å•†ä¸š/èŒåœºç±»
        business_keywords = ['å•†ä¸š', 'åˆ›ä¸š', 'ç®¡ç†', 'è¥é”€', 'èŒåœº', 'é¢è¯•', 'ç®€å†', 
                            'æŠ•èµ„', 'ç†è´¢', 'è‚¡ç¥¨', 'ç»æµ']
        
        for kw in tech_keywords:
            if kw in combined:
                return 'tech'
        
        for kw in person_keywords:
            if kw in combined:
                return 'person'
        
        for kw in science_keywords:
            if kw in combined:
                return 'science'
        
        for kw in life_keywords:
            if kw in combined:
                return 'life'
        
        for kw in business_keywords:
            if kw in combined:
                return 'business'
        
        return 'general'
    
    def _get_prompt_template(self, topic_type: str) -> str:
        """
        æ ¹æ®ä¸»é¢˜ç±»å‹è¿”å›å¯¹åº”çš„æç¤ºè¯æ¨¡æ¿
        """
        templates = {
            'tech': """ã€æ–‡ç« ç±»å‹ã€‘æŠ€æœ¯æ•™ç¨‹ç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. ä»¥æ¦‚å¿µè®²è§£ä¸ºä¸»ï¼Œä»£ç ç¤ºä¾‹ä¸ºè¾…ï¼ˆæ–‡å­—å†…å®¹å 70%ä»¥ä¸Šï¼‰
2. æ¯ä¸ªçŸ¥è¯†ç‚¹å¿…é¡»è®²é€å½»ï¼šå®šä¹‰â†’åŸç†â†’åº”ç”¨åœºæ™¯â†’æ³¨æ„äº‹é¡¹
3. ä¸“ä¸šã€ç³»ç»Ÿã€è¯¦ç»†ï¼Œåƒæ•™ç§‘ä¹¦ä¸€æ ·ä¸¥è°¨

ã€æ–‡ç« ç»“æ„ã€‘
# [æ ‡é¢˜]
> ğŸ“š **å¯¼è¯»**ï¼š[æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ¦‚æ‹¬]

## 1. æ¦‚è¿°ä¸èƒŒæ™¯
[è¯¦ç»†ä»‹ç»è¯¥æŠ€æœ¯çš„èƒŒæ™¯ã€å‘å±•å†ç¨‹ã€ä¸ºä»€ä¹ˆé‡è¦]

## 2. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£
### 2.1 [æ¦‚å¿µåç§°]
**å®šä¹‰**ï¼š[å‡†ç¡®çš„å®šä¹‰]
**åŸç†**ï¼š[åº•å±‚åŸç†è¯¦ç»†è§£é‡Š]
**åº”ç”¨åœºæ™¯**ï¼š[ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨]

## 3. å®è·µç¤ºä¾‹
```è¯­è¨€
// ç®€æ´çš„ç¤ºä¾‹ä»£ç ï¼Œé…åˆè¯¦ç»†æ³¨é‡Š
```
**ä»£ç è§£æ**ï¼š[é€è¡Œè§£é‡Šä»£ç å«ä¹‰]

## 4. æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜
- âœ… [å®è·µå»ºè®®]
- âŒ [å¸¸è§è¯¯åŒº]

## 5. æ€»ç»“
[æ ¸å¿ƒè¦ç‚¹å›é¡¾å’Œå»¶ä¼¸å­¦ä¹ æ–¹å‘]""",

            'person': """ã€æ–‡ç« ç±»å‹ã€‘äººç‰©ä»‹ç»ç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. ä»¥äººç‰©æ•…äº‹å’Œç»å†ä¸ºä¸»çº¿ï¼Œç”ŸåŠ¨æœ‰è¶£
2. çªå‡ºäººç‰©ç‰¹ç‚¹ã€æˆå°±å’Œå½±å“åŠ›
3. å®¢è§‚çœŸå®ï¼Œæœ‰æ®å¯æŸ¥
4. ä¸éœ€è¦ä»»ä½•ä»£ç ç¤ºä¾‹

ã€æ–‡ç« ç»“æ„ã€‘
# [äººç‰©åç§°]ï¼š[ä¸€å¥è¯æ¦‚æ‹¬å…¶ç‰¹ç‚¹æˆ–æˆå°±]

> ğŸŒŸ **äººç‰©ç®€ä»‹**ï¼š[ç®€çŸ­ä»‹ç»äººç‰©èº«ä»½å’Œä¸»è¦æˆå°±]

![äººç‰©å½¢è±¡](æ ¹æ®äººç‰©ç‰¹ç‚¹ç”Ÿæˆçš„é…å›¾æè¿°)

## 1. åŸºæœ¬ä¿¡æ¯
- **å‡ºç”Ÿæ—¥æœŸ**ï¼š[æ—¥æœŸ]
- **å‡ºç”Ÿåœ°**ï¼š[åœ°ç‚¹]
- **èŒä¸š**ï¼š[èŒä¸š]
- **ä»£è¡¨ä½œå“/æˆå°±**ï¼š[åˆ—ä¸¾]

## 2. æˆé•¿ç»å†
[ç«¥å¹´ã€æ±‚å­¦ã€æ—©æœŸç»å†ç­‰ï¼Œè®²è¿°æˆé•¿æ•…äº‹]

## 3. èŒä¸šç”Ÿæ¶¯
### 3.1 å‡ºé“/èµ·æ­¥
[å¦‚ä½•å¼€å§‹èŒä¸šç”Ÿæ¶¯]

### 3.2 æˆåä¹‹è·¯
[é‡è¦è½¬æŠ˜ç‚¹å’Œä»£è¡¨ä½œå“]

### 3.3 å·…å³°æ—¶åˆ»
[æœ€è¾‰ç…Œçš„æˆå°±]

## 4. ä¸ªäººç‰¹ç‚¹ä¸é£æ ¼
[æ€§æ ¼ç‰¹ç‚¹ã€è‰ºæœ¯é£æ ¼ã€ç‹¬ç‰¹ä¹‹å¤„]

## 5. ç¤¾ä¼šå½±å“ä¸è¯„ä»·
[å…¬ä¼—è¯„ä»·ã€ç¤¾ä¼šè´¡çŒ®ã€å½±å“åŠ›]

## 6. è¶£é—»è½¶äº‹
[æœ‰è¶£çš„å°æ•…äº‹ï¼Œè®©äººç‰©æ›´ç«‹ä½“]

## 7. æ€»ç»“
[å¯¹äººç‰©çš„æ•´ä½“è¯„ä»·å’Œæ„ä¹‰]""",

            'science': """ã€æ–‡ç« ç±»å‹ã€‘ç§‘æ™®çŸ¥è¯†ç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. æ·±å…¥æµ…å‡ºï¼Œç”¨é€šä¿—è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µ
2. å¤šç”¨ç±»æ¯”ã€æ¯”å–»å¸®åŠ©ç†è§£
3. å›¾æ–‡å¹¶èŒ‚ï¼Œå¢å¼ºå¯è¯»æ€§
4. ä¸éœ€è¦ä»£ç ç¤ºä¾‹

ã€æ–‡ç« ç»“æ„ã€‘
# [æ ‡é¢˜]ï¼š[å¼•äººå…¥èƒœçš„å‰¯æ ‡é¢˜]

> ğŸ”¬ **å¯¼è¯»**ï¼š[ç”¨ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æˆ–ç°è±¡å¼•å…¥]

## 1. å¼•è¨€
[ç”¨ç”Ÿæ´»ä¸­çš„ä¾‹å­æˆ–æœ‰è¶£çš„é—®é¢˜å¼•å…¥ä¸»é¢˜]

## 2. åŸºæœ¬æ¦‚å¿µ
### ä»€ä¹ˆæ˜¯[ä¸»é¢˜]ï¼Ÿ
[ç”¨æœ€ç®€å•çš„è¯­è¨€è§£é‡Š]

### ç”Ÿæ´»ä¸­çš„ä¾‹å­
[ä¸¾å‡ ä¸ªè´´è¿‘ç”Ÿæ´»çš„ä¾‹å­]

## 3. åŸç†è§£æ
### 3.1 [åŸç†1]
[è¯¦ç»†è§£é‡Šï¼Œé…åˆç±»æ¯”]

### 3.2 [åŸç†2]
[è¯¦ç»†è§£é‡Šï¼Œé…åˆç±»æ¯”]

## 4. å‘å±•å†å²
[é‡è¦çš„å‘ç°å’Œé‡Œç¨‹ç¢‘]

## 5. å®é™…åº”ç”¨
[åœ¨ç”Ÿæ´»ã€ç§‘æŠ€ä¸­çš„åº”ç”¨]

## 6. æœ‰è¶£çš„äº‹å®
[ç›¸å…³çš„è¶£å‘³çŸ¥è¯†ç‚¹]

## 7. æ€»ç»“ä¸å±•æœ›
[æ€»ç»“è¦ç‚¹ï¼Œå±•æœ›æœªæ¥å‘å±•]""",

            'life': """ã€æ–‡ç« ç±»å‹ã€‘ç”Ÿæ´»å¨±ä¹ç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. è½»æ¾æœ‰è¶£ï¼Œè´´è¿‘ç”Ÿæ´»
2. å®ç”¨æ€§å¼ºï¼Œæœ‰å…·ä½“å»ºè®®
3. å›¾æ–‡å¹¶èŒ‚ï¼Œå¢å¼ºé˜…è¯»ä½“éªŒ
4. ä¸éœ€è¦ä»£ç ç¤ºä¾‹

ã€æ–‡ç« ç»“æ„ã€‘
# [æ ‡é¢˜]

> âœ¨ **å¯¼è¯»**ï¼š[ç®€çŸ­æœ‰è¶£çš„å¼•è¨€]

## 1. å¼€ç¯‡
[ç”¨è½»æ¾çš„æ–¹å¼å¼•å…¥è¯é¢˜]

## 2. [ä¸»é¢˜]çš„é­…åŠ›
[ä¸ºä»€ä¹ˆå€¼å¾—å…³æ³¨/ä½“éªŒ]

## 3. è¯¦ç»†ä»‹ç»
### 3.1 [æ–¹é¢1]
[è¯¦ç»†å†…å®¹]

### 3.2 [æ–¹é¢2]
[è¯¦ç»†å†…å®¹]

## 4. å®ç”¨å»ºè®®/æ¨è
[å…·ä½“çš„å»ºè®®ã€æ¨èåˆ—è¡¨]

## 5. æ³¨æ„äº‹é¡¹
[éœ€è¦æ³¨æ„çš„åœ°æ–¹]

## 6. æ€»ç»“
[è½»æ¾çš„ç»“å°¾ï¼Œé¼“åŠ±è¯»è€…å°è¯•]""",

            'business': """ã€æ–‡ç« ç±»å‹ã€‘å•†ä¸šèŒåœºç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. ä¸“ä¸šä¸¥è°¨ï¼Œæœ‰ç†æœ‰æ®
2. ç»“åˆæ¡ˆä¾‹åˆ†æ
3. æä¾›å¯æ“ä½œçš„å»ºè®®
4. ä¸éœ€è¦ä»£ç ç¤ºä¾‹ï¼ˆé™¤éæ˜¯æŠ€æœ¯å²—ä½ç›¸å…³ï¼‰

ã€æ–‡ç« ç»“æ„ã€‘
# [æ ‡é¢˜]

> ğŸ’¼ **å¯¼è¯»**ï¼š[æ ¸å¿ƒè§‚ç‚¹æ¦‚æ‹¬]

## 1. èƒŒæ™¯ä¸ç°çŠ¶
[è¡Œä¸š/é¢†åŸŸçš„ç°çŠ¶åˆ†æ]

## 2. æ ¸å¿ƒæ¦‚å¿µ
### 2.1 [æ¦‚å¿µ1]
[è¯¦ç»†è§£é‡Š]

### 2.2 [æ¦‚å¿µ2]
[è¯¦ç»†è§£é‡Š]

## 3. æ¡ˆä¾‹åˆ†æ
### æ¡ˆä¾‹ä¸€ï¼š[æ¡ˆä¾‹åç§°]
[è¯¦ç»†åˆ†æ]

### æ¡ˆä¾‹äºŒï¼š[æ¡ˆä¾‹åç§°]
[è¯¦ç»†åˆ†æ]

## 4. å®è·µç­–ç•¥
[å…·ä½“å¯æ“ä½œçš„å»ºè®®]

## 5. å¸¸è§è¯¯åŒº
[éœ€è¦é¿å…çš„é”™è¯¯]

## 6. æ€»ç»“ä¸å»ºè®®
[æ ¸å¿ƒè¦ç‚¹å’Œè¡ŒåŠ¨å»ºè®®]""",

            'general': """ã€æ–‡ç« ç±»å‹ã€‘é€šç”¨çŸ¥è¯†ç±»
ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. æ ¹æ®ä¸»é¢˜ç‰¹ç‚¹çµæ´»è°ƒæ•´å†…å®¹é£æ ¼
2. å†…å®¹å……å®ï¼Œç»“æ„æ¸…æ™°
3. è¯­è¨€é€šä¿—æ˜“æ‡‚
4. åªåœ¨å¿…è¦æ—¶æ‰åŒ…å«ä»£ç ç¤ºä¾‹

ã€æ–‡ç« ç»“æ„ã€‘
# [æ ‡é¢˜]

> ğŸ“– **å¯¼è¯»**ï¼š[æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ¦‚æ‹¬]

## 1. å¼•è¨€
[ä»‹ç»ä¸»é¢˜èƒŒæ™¯å’Œé‡è¦æ€§]

## 2. ä¸»è¦å†…å®¹
### 2.1 [è¦ç‚¹1]
[è¯¦ç»†å†…å®¹]

### 2.2 [è¦ç‚¹2]
[è¯¦ç»†å†…å®¹]

### 2.3 [è¦ç‚¹3]
[è¯¦ç»†å†…å®¹]

## 3. æ·±å…¥åˆ†æ
[æ›´æ·±å±‚æ¬¡çš„æ¢è®¨]

## 4. å®é™…åº”ç”¨/æ¡ˆä¾‹
[å…·ä½“çš„ä¾‹å­æˆ–åº”ç”¨åœºæ™¯]

## 5. æ€»ç»“
[æ ¸å¿ƒè¦ç‚¹å›é¡¾]"""
        }
        
        return templates.get(topic_type, templates['general'])
    
    def _generate_image_prompt(self, topic: str, section: str = "") -> str:
        """
        æ ¹æ®ä¸»é¢˜ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
        """
        prompt = f"""ä¸ºæ–‡ç« ã€Œ{topic}ã€ç”Ÿæˆä¸€å¼ é…å›¾ã€‚
{f'å›¾ç‰‡ç”¨äºç« èŠ‚ï¼š{section}' if section else ''}

è¦æ±‚ï¼š
1. å›¾ç‰‡é£æ ¼ï¼šç°ä»£ã€ä¸“ä¸šã€é«˜è´¨é‡
2. é€‚åˆä½œä¸ºæ–‡ç« é…å›¾
3. ä¸åŒ…å«æ–‡å­—
4. è‰²å½©å’Œè°ï¼Œè§†è§‰æ•ˆæœå¥½

ç›´æ¥è¿”å›è‹±æ–‡çš„å›¾ç‰‡æè¿°æç¤ºè¯ï¼Œä¸è¶…è¿‡100ä¸ªå•è¯ã€‚"""
        
        return self.chat(prompt, temperature=0.8)
    
    def _generate_image(self, prompt: str) -> str:
        """
        è°ƒç”¨å›¾ç‰‡ç”ŸæˆAPIç”Ÿæˆå›¾ç‰‡
        è¿”å›å›¾ç‰‡URL
        """
        try:
            # ä½¿ç”¨ SiliconFlow çš„å›¾ç‰‡ç”Ÿæˆ API
            api_key = AI_CONFIG.get("api_key", "")
            if not api_key:
                return ""
            
            response = requests.post(
                "https://api.siliconflow.cn/v1/images/generations",
                headers={
                    "Authorization": f"Bearer {api_key}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": "black-forest-labs/FLUX.1-schnell",
                    "prompt": prompt,
                    "image_size": "1024x576",
                    "num_inference_steps": 20
                },
                timeout=60
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("images") and len(data["images"]) > 0:
                    return data["images"][0].get("url", "")
            return ""
        except Exception as e:
            print(f"å›¾ç‰‡ç”Ÿæˆå¤±è´¥: {e}")
            return ""
    
    def generate_article(self, topic: str, description: str = "", extra_context: str = "", generate_images: bool = True) -> dict:
        """
        ç”Ÿæˆå®Œæ•´çš„å­¦ä¹ æ–‡ç« 
        
        Args:
            topic: æ–‡ç« ä¸»é¢˜
            description: è¡¥å……æè¿°
            extra_context: é¢å¤–çš„å‚è€ƒèµ„æ–™
            generate_images: æ˜¯å¦ç”Ÿæˆé…å›¾
            
        Returns:
            åŒ…å«æ ‡é¢˜å’Œå†…å®¹çš„å­—å…¸
        """
        # æ£€æµ‹ä¸»é¢˜ç±»å‹
        topic_type = self._detect_topic_type(topic, description)
        template = self._get_prompt_template(topic_type)
        
        context_section = ""
        if extra_context:
            context_section = f"\n\nã€å‚è€ƒèµ„æ–™ã€‘\n{extra_context[:3000]}\n"

        prompt = f"""æ’°å†™ä¸€ç¯‡å…³äºã€Œ{topic}ã€çš„æ–‡ç« ã€‚{f' è¡¥å……è¦æ±‚ï¼š{description}' if description else ''}{context_section}

{template}

ã€é‡è¦æé†’ã€‘
1. ä¸¥æ ¼æ ¹æ®ä¸»é¢˜ç±»å‹è°ƒæ•´å†…å®¹ï¼Œä¸è¦ç”Ÿæ¬ç¡¬å¥—æ¨¡æ¿
2. å¦‚æœä¸»é¢˜ä¸æŠ€æœ¯/ç¼–ç¨‹æ— å…³ï¼Œç»å¯¹ä¸è¦åŒ…å«ä»£ç ç¤ºä¾‹
3. æ–‡ç« è¦æœ‰æ·±åº¦å’Œå¹¿åº¦ï¼Œå­—æ•°3000-5000å­—
4. å†…å®¹è¦çœŸå®ã€å‡†ç¡®ã€æœ‰ä»·å€¼
5. åœ¨é€‚åˆæ’å…¥å›¾ç‰‡çš„ä½ç½®ï¼Œä½¿ç”¨ ![å›¾ç‰‡æè¿°](IMAGE_PLACEHOLDER_N) æ ¼å¼æ ‡è®°ï¼ŒNä¸ºåºå·

ç›´æ¥è¾“å‡ºæ–‡ç« å†…å®¹ï¼Œä½¿ç”¨Markdownæ ¼å¼ã€‚"""

        content = self.chat(prompt, temperature=0.7)
        
        # ç”Ÿæˆé…å›¾
        if generate_images:
            # æŸ¥æ‰¾æ‰€æœ‰å›¾ç‰‡å ä½ç¬¦
            image_placeholders = re.findall(r'!\[([^\]]*)\]\(IMAGE_PLACEHOLDER_(\d+)\)', content)
            
            for desc, idx in image_placeholders:
                # ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
                image_prompt = self._generate_image_prompt(topic, desc)
                # ç”Ÿæˆå›¾ç‰‡
                image_url = self._generate_image(image_prompt)
                
                if image_url:
                    # æ›¿æ¢å ä½ç¬¦ä¸ºå®é™…å›¾ç‰‡URL
                    content = content.replace(
                        f'![{desc}](IMAGE_PLACEHOLDER_{idx})',
                        f'![{desc}]({image_url})'
                    )
                else:
                    # å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œç§»é™¤å ä½ç¬¦
                    content = content.replace(f'![{desc}](IMAGE_PLACEHOLDER_{idx})\n', '')
                    content = content.replace(f'![{desc}](IMAGE_PLACEHOLDER_{idx})', '')
        
        # æå–æ ‡é¢˜
        lines = content.strip().split('\n')
        title = topic
        if lines and lines[0].startswith('#'):
            title = lines[0].lstrip('#').strip()
        
        return {
            "title": title,
            "content": content,
            "topic": topic,
            "topic_type": topic_type,
            "word_count": len(content)
        }
